// Prisma Schema for House of Spells E-commerce Platform

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & AUTH
// ============================================

model User {
  id            Int       @id @default(autoincrement())
  name          String
  email         String    @unique
  password      String
  phone         String?
  loyaltyPoints Int       @default(0)
  role          String    @default("customer") // admin, seller, customer, etc.
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  addresses     Address[]
  orders        Order[]
  reviews       Review[]
  wishlistItems WishlistItem[]
  seller        Seller?
}

model Address {
  id           Int      @id @default(autoincrement())
  userId       Int
  isDefault    Boolean  @default(false)
  firstName    String
  lastName     String
  addressLine1 String
  addressLine2 String?
  city         String
  postalCode   String
  country      String   @default("GB")
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Role {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String?
  permissions String[] // Array of permission strings
  createdAt   DateTime @default(now())
}

// ============================================
// PRODUCTS
// ============================================

model Product {
  id               Int       @id @default(autoincrement())
  sku              String    @unique
  barcode          String?
  sellerId         Int
  hasVariations    Boolean   @default(false)
  fulfillmentModel String    @default("HoS Warehouse")
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Localized content stored as JSON
  name        Json // { en: string, es: string, ... }
  description Json // { en: string, es: string, ... }

  // Multi-currency pricing stored as JSON
  pricing    Json // { GBP: number, USD: number, EUR: number, JPY: number }
  rrp        Json? // Recommended retail price
  tradePrice Json? // B2B pricing

  // Taxonomy
  fandom      String
  subCategory String

  seller     Seller          @relation(fields: [sellerId], references: [id])
  media      ProductMedia[]
  inventory  InventoryItem[]
  variations ProductVariation[]
  orderItems OrderItem[]
  reviews    Review[]
  wishlistItems WishlistItem[]
}

model ProductMedia {
  id        Int    @id @default(autoincrement())
  productId Int
  type      String @default("image") // image, video, image_360
  url       String

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model InventoryItem {
  id        Int    @id @default(autoincrement())
  productId Int?
  variationId Int?
  centreId  String @default("main")
  name      String @default("Main Warehouse")
  stock     Int    @default(0)

  product   Product?          @relation(fields: [productId], references: [id], onDelete: Cascade)
  variation ProductVariation? @relation(fields: [variationId], references: [id], onDelete: Cascade)
}

model ProductVariation {
  id           Int    @id @default(autoincrement())
  productId    Int
  sku          String @unique
  name         String
  optionValues Json   // { size: "M", color: "Red" }

  product   Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  inventory InventoryItem[]
  orderItems OrderItem[]
}

// ============================================
// SELLERS
// ============================================

model Seller {
  id              Int      @id @default(autoincrement())
  userId          Int?     @unique
  name            String
  businessName    String?
  contactEmail    String
  type            String   @default("independent") // independent, authorized, distributor
  status          String   @default("pending") // pending, approved, rejected
  isVerified      Boolean  @default(false)
  payoutsEnabled  Boolean  @default(false)
  applicationDate DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Theme settings as JSON
  theme          Json? // { activeTheme, customizations }
  unlockedThemes String[] // Array of theme IDs

  // Financial data as JSON
  financials Json? // { balance, pendingBalance, totalEarnings, etc. }

  // Performance metrics as JSON
  performance Json? // { totalSales, averageRating, etc. }

  user      User?            @relation(fields: [userId], references: [id])
  products  Product[]
  auditLogs SellerAuditLog[]
  payouts   Payout[]
}

model SellerAuditLog {
  id        Int      @id @default(autoincrement())
  sellerId  Int
  action    String
  admin     String
  timestamp DateTime @default(now())
  notes     String?

  seller Seller @relation(fields: [sellerId], references: [id], onDelete: Cascade)
}

model Payout {
  id        Int      @id @default(autoincrement())
  sellerId  Int
  amount    Float
  currency  String
  status    String   @default("pending") // pending, processing, completed, failed
  method    String?
  reference String?
  createdAt DateTime @default(now())
  processedAt DateTime?

  seller Seller @relation(fields: [sellerId], references: [id])
}

// ============================================
// ORDERS
// ============================================

model Order {
  id              String   @id
  userId          Int?
  date            DateTime @default(now())
  status          String   @default("Processing")
  currency        String   @default("GBP")
  
  subtotal        Float
  shippingCost    Float    @default(0)
  taxes           Float    @default(0)
  discountAmount  Float    @default(0)
  total           Float
  
  // Platform fee as JSON { local: number, base: number }
  platformFee     Json?
  sellerPayout    Float?

  shippingMethod  String?
  carrier         String?
  trackingNumber  String?
  trackingUrl     String?
  shippingNotes   String?

  // Shipping address as JSON
  shippingAddress Json

  // Payment details as JSON
  paymentDetails  Json?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User?           @relation(fields: [userId], references: [id])
  items           OrderItem[]
  auditLogs       OrderAuditLog[]
  returnRequests  ReturnRequest[]
}

model OrderItem {
  id          Int    @id @default(autoincrement())
  orderId     String
  productId   Int
  variationId Int?
  quantity    Int
  price       Float
  currency    String @default("GBP")

  order     Order             @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product   Product           @relation(fields: [productId], references: [id])
  variation ProductVariation? @relation(fields: [variationId], references: [id])
}

model OrderAuditLog {
  id             Int      @id @default(autoincrement())
  orderId        String
  timestamp      DateTime @default(now())
  user           String
  previousStatus String?
  newStatus      String
  notes          String?

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
}

// ============================================
// RETURNS
// ============================================

model ReturnRequest {
  id          String   @id @default(cuid())
  orderId     String
  reason      String
  details     String?
  status      String   @default("Pending Review") // Pending Review, Approved, Rejected, Completed
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Return shipping info
  returnLabel String?
  refundAmount Float?
  refundMethod String?

  order Order @relation(fields: [orderId], references: [id])
}

// ============================================
// REVIEWS
// ============================================

model Review {
  id                Int      @id @default(autoincrement())
  productId         Int
  userId            Int
  userName          String
  rating            Int      // 1-5
  comment           String?
  isVerifiedPurchase Boolean @default(false)
  date              DateTime @default(now())

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id])
}

// ============================================
// WISHLIST
// ============================================

model WishlistItem {
  id        Int      @id @default(autoincrement())
  userId    Int
  productId Int
  addedAt   DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
}

// ============================================
// PROMOTIONS
// ============================================

model Promotion {
  id           Int      @id @default(autoincrement())
  code         String   @unique
  type         String   // percentage, fixed, freeShipping
  value        Float?
  description  String?
  minPurchase  Float?
  maxUses      Int?
  usedCount    Int      @default(0)
  validFrom    DateTime
  validTo      DateTime
  isActive     Boolean  @default(true)
  applicableTo String[] // Array of product IDs or categories
  createdAt    DateTime @default(now())
}

// ============================================
// TRANSACTIONS
// ============================================

model Transaction {
  id          Int      @id @default(autoincrement())
  sellerId    Int?
  type        String   // sale, payout, refund, fee, adjustment
  amount      Float
  currency    String   @default("GBP")
  reference   String?  // Order ID or other reference
  description String?
  status      String   @default("completed")
  processedBy String?
  date        DateTime @default(now())
}

// ============================================
// CARRIERS
// ============================================

model Carrier {
  id           Int      @id @default(autoincrement())
  name         String
  code         String   @unique
  trackingUrl  String?
  logo         String?
  isActive     Boolean  @default(true)
  services     Json?    // Array of service types
  rates        Json?    // Shipping rates configuration
  createdAt    DateTime @default(now())
}

// ============================================
// PLATFORM SETTINGS
// ============================================

model ThemeConfiguration {
  id              String   @id
  name            String
  description     String?
  preview         String?  // Preview image URL
  isDefault       Boolean  @default(false)
  isCustom        Boolean  @default(false)
  isPremium       Boolean  @default(false)
  price           Float?
  cssContent      String?  @db.Text
  variables       Json?    // CSS variables
  layout          String   @default("standard")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model IntegrationSettings {
  id        Int      @id @default(1)
  settings  Json     // All integration settings as JSON
  updatedAt DateTime @updatedAt
}

model HomePageContent {
  id        Int      @id @default(1)
  content   Json     // All homepage content as JSON
  updatedAt DateTime @updatedAt
}

